import*as e from"../../core/i18n/i18n.js";import*as t from"../../ui/legacy/legacy.js";import*as o from"../../core/sdk/sdk.js";import*as n from"../../third_party/react-devtools/react-devtools.js";import*as s from"../../core/common/common.js";import*as i from"../../models/workspace/workspace.js";import*as r from"../../models/react_native/react_native.js";import*as a from"../../models/bindings/bindings.js";import*as d from"../../models/logs/logs.js";const l="main";class c extends o.SDKModel.SDKModel{static FUSEBOX_BINDING_NAMESPACE="react-devtools";rdtModel;constructor(e){super(e);const t=e.model(r.ReactDevToolsBindingsModel.ReactDevToolsBindingsModel);if(!t)throw new Error("Failed to construct ReactDevToolsModel: ReactDevToolsBindingsModel was null");this.rdtModel=t,t.addEventListener("Initialized",this.initialize,this)}initialize(){const e=this.rdtModel;if(!e)throw new Error("Failed to initialize ReactDevToolsModel: ReactDevToolsBindingsModel was null");e.subscribeToDomainMessages(c.FUSEBOX_BINDING_NAMESPACE,(e=>this.onMessage(e))),e.initializeDomain(c.FUSEBOX_BINDING_NAMESPACE).then((()=>this.onInitialization()))}onInitialization(){const e=function(){const e=t.Context.Context.instance().flavor(o.RuntimeModel.ExecutionContext);return e?.name!==l?null:e}();e&&this.dispatchEventToListeners("Initialized",e),o.TargetManager.TargetManager.instance().addModelListener(o.RuntimeModel.RuntimeModel,o.RuntimeModel.Events.ExecutionContextCreated,this.onExecutionContextCreated,this),o.TargetManager.TargetManager.instance().addModelListener(o.RuntimeModel.RuntimeModel,o.RuntimeModel.Events.ExecutionContextDestroyed,this.onExecutionContextDestroyed,this)}onExecutionContextCreated({data:e}){e.name===l&&this.dispatchEventToListeners("Initialized",e)}onExecutionContextDestroyed({data:e}){e.name===l&&this.dispatchEventToListeners("Destroyed")}onMessage(e){this.dispatchEventToListeners("MessageReceived",e)}async sendMessage(e){const t=this.rdtModel;if(!t)throw new Error("Failed to send message from ReactDevToolsModel: ReactDevToolsBindingsModel was null");return t.sendMessage(c.FUSEBOX_BINDING_NAMESPACE,e)}}o.SDKModel.SDKModel.register(c,{capabilities:4,autostart:!1});var g=Object.freeze({__proto__:null,ReactDevToolsModel:c});const h={title:"React DevTools"},u=e.i18n.registerUIStrings("panels/react_devtools/ReactDevToolsView.ts",h),m=e.i18n.getLocalizedString.bind(void 0,u);function M(e,t){const{sourceURL:o,line:n,column:r}=t||e;!async function(e,t,o){const n=i.Workspace.WorkspaceImpl.instance().uiSourceCodeForURL(e);if(n){const e=await a.DebuggerWorkspaceBinding.DebuggerWorkspaceBinding.instance().normalizeUILocation(n.uiLocation(t,o));return void s.Revealer.reveal(e)}const r=a.ResourceUtils.resourceForURL(e);if(r)return void s.Revealer.reveal(r);const l=d.NetworkLog.NetworkLog.instance().requestForURL(e);if(!l)throw new Error("Could not find resource for "+e);s.Revealer.reveal(l)}(o,n-1,r-1)}class v extends t.View.SimpleView{wall;bridge=null;store=null;executionContext=null;listeners=new Set;constructor(){super(m(h.title)),this.wall={listen:e=>(this.listeners.add(e),()=>{this.listeners.delete(e)}),send:(e,t)=>this.sendMessage(e,t)},window.addEventListener("beforeunload",(()=>this.bridge?.shutdown())),o.TargetManager.TargetManager.instance().addModelListener(c,"Initialized",this.onInitialized,this),o.TargetManager.TargetManager.instance().addModelListener(c,"Destroyed",this.onDestroyed,this),o.TargetManager.TargetManager.instance().addModelListener(c,"MessageReceived",this.onMessage,this),this.renderLoader()}onInitialized({data:e}){this.clearLoader(),this.executionContext=e,this.bridge=n.createBridge(this.wall),this.store=n.createStore(this.bridge);const t=window.matchMedia("(prefers-color-scheme: dark)").matches;n.initialize(this.contentElement,{bridge:this.bridge,store:this.store,theme:t?"dark":"light",canViewElementSourceFunction:()=>!0,viewElementSourceFunction:M})}onDestroyed(){this.contentElement.removeChildren(),this.executionContext=null,this.bridge?.shutdown(),this.bridge=null,this.store=null,this.listeners.clear(),this.renderLoader()}renderLoader(){const e=document.createElement("div");e.setAttribute("style","display: flex; flex: 1; justify-content: center; align-items: center");const t=document.createElement("span");t.classList.add("spinner"),e.appendChild(t),this.contentElement.appendChild(e)}clearLoader(){this.contentElement.removeChildren()}wasShown(){super.wasShown(),this.registerCSSFiles([n.CSS])}onMessage({data:e}){if(e)for(const t of this.listeners)t(e)}sendMessage(e,t){for(const n of o.TargetManager.TargetManager.instance().models(c,{scoped:!0}))n.sendMessage({event:e,payload:t})}}var p=Object.freeze({__proto__:null,ReactDevToolsViewImpl:v});export{g as ReactDevToolsModel,p as ReactDevToolsView};
