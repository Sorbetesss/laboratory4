<!doctype html>
<!--
  Copyright (c) 2015-present, Facebook, Inc.
  All rights reserved.

  This source code is licensed under the BSD-style license found in the
  LICENSE file in the root directory of this source tree. An additional grant
  of patent rights can be found in the PATENTS file in the same directory.
-->

<html>
<head>
<meta charset=utf-8>
<!-- Fake favicon, to avoid extra request to server -->
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<title>React Native Debugger</title>
<script>
(function() {

var sessionID = window.localStorage.getItem('sessionID');
window.localStorage.removeItem('sessionID');

window.onbeforeunload = function() {
  if (sessionID) {
    return 'If you reload this page, it is going to break the debugging session. ' +
      'You should ⌘+R in the iOS simulator to reload.';
  }
};

function setStatus(status) {
  document.getElementById('status').innerHTML = status;
}

// This worker will run the application javascript code,
// making sure that it's run in an environment without a global
// document, to make it consistent with the JSC executor environment.
var worker = new Worker('debuggerWorker.js');

var messageHandlers = {
  // This method is a bit hacky. Catalyst asks for a new clean JS runtime.
  // The easiest way to do this is to reload this page. That also means that
  // web socket connection will be lost. To send reply back we need to remember
  // message id.
  // This message also needs to be handled outside of the worker, since the worker
  // doesn't have access to local storage.
  'prepareJSRuntime': function(message) {
    window.onbeforeunload = undefined;
    window.localStorage.setItem('sessionID', message.id);
    window.location.reload();
  },
  'executeApplicationScript': function(message) {
    worker.postMessage(message);
  },
  'executeJSCall': function(message){
    worker.postMessage(message);
  }
}

var ws = new WebSocket('ws://' + window.location.host + '/debugger-proxy');

ws.onopen = function() {
  if (sessionID) {
    setStatus('Debugger session #' + sessionID + ' active');
    ws.send(JSON.stringify({replyID: parseInt(sessionID, 10)}));
  } else {
    setStatus('Waiting, press ⌘R in simulator to reload and connect');
  }
}

ws.onmessage = function(message) {
  var object = JSON.parse(message.data);
  var handler = messageHandlers[object.method];

  if (handler) {
    handler(object);
  } else {
    console.warn('Unknown method: ' + object.method);
  }
}

ws.onclose = function() {
  setStatus('Disconnected from proxy. Is node server running?');
}

worker.onmessage = function(message) {
  ws.send(JSON.stringify(message.data));
}

})();
</script>
<style type="text/css">
  .shortcut {
    font-family: monospace;
    color: #eee;
    background-color: #333;
    padding: 4px;
    border-radius: 4px;
    letter-spacing: 3px;
  }
  body {
    font-size: large;
  }
</style>
</head>
<body>
  <p>
    React Native JS code runs inside this Chrome tab
  </p>
  <p>Press <span class="shortcut">⌘⌥J</span> to open Developer Tools. Enable <a href="http://stackoverflow.com/a/17324511/232122" target="_blank">Pause On Caught Exceptions</a> for a better debugging experience.</p>
  <p>Status: <span id="status">Loading</span></p>
</body>
</html>
