name: build-hermes-macos
description: This action builds hermesc for Apple platforms
inputs:
  HERMES_VERSION:
    required: true
    description: The version of Hermes
  REACT_NATIVE_VERSION:
    required: true
    description: The version of React Native
  FLAVOR:
    required: true
    description: The flavor we want to build. It can be Debug or Release
runs:
  using: composite
  steps:
    - name: Setup xcode
      uses: ./.github/actions/setup-xcode
    - name: Setup node.js
      uses: ./.github/actions/setup-node
    - name: Restore Hermes workspace
      uses: ./.github/actions/restore-hermes-workspace
    - name: Restore Cached Artifacts
      uses: actions/cache/restore@v4.0.0
      with:
        key: v3-hermes-artifacts-${{ inputs.FLAVOR }}-${{ inputs.HERMES_VERSION }}-${{ inputs.REACT_NATIVE_VERSION }}
        path: |
          /tmp/hermes/osx-bin/${{ inputs.FLAVOR }}
          /tmp/hermes/dSYM/${{ inputs.FLAVOR }}
          /tmp/hermes/hermes-runtime-darwin/hermes-ios-${{ inputs.FLAVOR }}.tar.gz
    - name: Check if the required artifacts already exist
      id: check_if_apple_artifacts_are_there
      shell: bash
      run: |
        FLAVOR="${{ inputs.FLAVOR }}"
        echo "Flavor is $FLAVOR"
        OSX_BIN="/tmp/hermes/osx-bin/$FLAVOR"
        DSYM="/tmp/hermes/dSYM/$FLAVOR"
        HERMES="/tmp/hermes/hermes-runtime-darwin/hermes-ios-$FLAVOR.tar.gz"

        if [[ -d "$OSX_BIN" ]] && \
            [[ -d "$DSYM" ]] && \
            [[ -f "$HERMES" ]]; then

          echo "Artifacts are there!"
          echo "ARTIFACTS_EXIST=true" >> $GITHUB_ENV
          echo "ARTIFACTS_EXIST=true" >> $GITHUB_OUTPUT
        fi
    - name: Yarn- Install Dependencies
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      shell: bash
      run: yarn install --non-interactive
    - name: Slice cache macosx
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      uses: actions/download-artifact@v4.1.3
      with:
        path: ./packages/react-native/sdks/hermes/build_macosx_${{ inputs.FLAVOR }}
        name: slice-macosx-${{ inputs.FLAVOR }}
    - name: Slice cache iphoneos
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      uses: actions/download-artifact@v4.1.3
      with:
        path: ./packages/react-native/sdks/hermes/build_iphoneos_${{ inputs.FLAVOR }}
        name: slice-iphoneos-${{ inputs.FLAVOR }}
    - name: Slice cache iphonesimulator
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      uses: actions/download-artifact@v4.1.3
      with:
        path: ./packages/react-native/sdks/hermes/build_iphonesimulator_${{ inputs.FLAVOR }}
        name: slice-iphonesimulator-${{ inputs.FLAVOR }}
    - name: Slice cache catalyst
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      uses: actions/download-artifact@v4.1.3
      with:
        path: ./packages/react-native/sdks/hermes/build_catalyst_${{ inputs.FLAVOR }}
        name: slice-catalyst-${{ inputs.FLAVOR }}
    - name: Slice cache xros
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      uses: actions/download-artifact@v4.1.3
      with:
        path: ./packages/react-native/sdks/hermes/build_xros_${{ inputs.FLAVOR }}
        name: slice-xros-${{ inputs.FLAVOR }}
    - name: Slice cache xrsimulator
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      uses: actions/download-artifact@v4.1.3
      with:
        path: ./packages/react-native/sdks/hermes/build_xrsimulator_${{ inputs.FLAVOR }}
        name: slice-xrsimulator-${{ inputs.FLAVOR }}
    - name: Move back build folders
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      shell: bash
      run: |
        ls -l ./packages/react-native/sdks/hermes
        cd ./packages/react-native/sdks/hermes || exit 1
        mv build_macosx_${{ inputs.FLAVOR }} build_macosx
        mv build_iphoneos_${{ inputs.FLAVOR }} build_iphoneos
        mv build_iphonesimulator_${{ inputs.FLAVOR }} build_iphonesimulator
        mv build_catalyst_${{ inputs.FLAVOR }} build_catalyst
        mv build_xros_${{ inputs.FLAVOR }} build_xros
        mv build_xrsimulator_${{ inputs.FLAVOR }} build_xrsimulator
    - name: Prepare destroot folder
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      shell: bash
      run: |
        cd ./packages/react-native/sdks/hermes || exit 1
        chmod +x ./utils/build-apple-framework.sh
        . ./utils/build-apple-framework.sh
        prepare_dest_root_for_ci
    - name: Create fat framework for iOS
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      shell: bash
      run: |
        cd ./packages/react-native/sdks/hermes || exit 1
        echo "[HERMES] Creating the universal framework"
        chmod +x ./utils/build-ios-framework.sh
        ./utils/build-ios-framework.sh build_framework

        chmod +x ./destroot/bin/hermesc
    - name: Package the Hermes Apple frameworks
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      shell: bash
      run: |
        BUILD_TYPE="${{ inputs.FLAVOR }}"
        echo "Packaging Hermes Apple frameworks for $BUILD_TYPE build type"

        TARBALL_OUTPUT_DIR=$(mktemp -d /tmp/hermes-tarball-output-XXXXXXXX)

        TARBALL_FILENAME=$(node ./packages/react-native/scripts/hermes/get-tarball-name.js --buildType "$BUILD_TYPE")

        echo "Packaging Hermes Apple frameworks for $BUILD_TYPE build type"

        TARBALL_OUTPUT_PATH=$(node ./packages/react-native/scripts/hermes/create-tarball.js \
          --inputDir ./packages/react-native/sdks/hermes \
          --buildType "$BUILD_TYPE" \
          --outputDir $TARBALL_OUTPUT_DIR)

        echo "Hermes tarball saved to $TARBALL_OUTPUT_PATH"

        mkdir -p $HERMES_TARBALL_ARTIFACTS_DIR
        cp $TARBALL_OUTPUT_PATH $HERMES_TARBALL_ARTIFACTS_DIR/.

        mkdir -p /tmp/hermes/osx-bin/${{ inputs.FLAVOR }}
        cp ./packages/react-native/sdks/hermes/build_macosx/bin/* /tmp/hermes/osx-bin/${{ inputs.FLAVOR }}
        ls -lR /tmp/hermes/osx-bin/
    - name: Create dSYM archive
      if: ${{ steps.check_if_apple_artifacts_are_there.outputs.ARTIFACTS_EXIST != 'true' }}
      shell: bash
      run: |
        FLAVOR=${{ inputs.FLAVOR }}
        WORKING_DIR="/tmp/hermes_tmp/dSYM/$FLAVOR"

        mkdir -p "$WORKING_DIR/macosx"
        mkdir -p "$WORKING_DIR/catalyst"
        mkdir -p "$WORKING_DIR/iphoneos"
        mkdir -p "$WORKING_DIR/iphonesimulator"
        mkdir -p "$WORKING_DIR/xros"
        mkdir -p "$WORKING_DIR/xrsimulator"

        cd ./packages/react-native/sdks/hermes || exit 1

        DSYM_FILE_PATH=API/hermes/hermes.framework.dSYM
        cp -r build_macosx/$DSYM_FILE_PATH "$WORKING_DIR/macosx/"
        cp -r build_catalyst/$DSYM_FILE_PATH "$WORKING_DIR/catalyst/"
        cp -r build_iphoneos/$DSYM_FILE_PATH "$WORKING_DIR/iphoneos/"
        cp -r build_iphonesimulator/$DSYM_FILE_PATH "$WORKING_DIR/iphonesimulator/"
        cp -r build_xros/$DSYM_FILE_PATH "$WORKING_DIR/xros/"
        cp -r build_xrsimulator/$DSYM_FILE_PATH "$WORKING_DIR/xrsimulator/"

        DEST_DIR="/tmp/hermes/dSYM/$FLAVOR"
        tar -C "$WORKING_DIR" -czvf "hermes.framework.dSYM" .

        mkdir -p "$DEST_DIR"
        mv "hermes.framework.dSYM" "$DEST_DIR"
    - name: Upload hermes dSYM artifacts
      uses: actions/upload-artifact@v4.3.1
      with:
        name: hermes-dSYM-${{ inputs.FLAVOR }}
        path: /tmp/hermes/dSYM/${{ inputs.FLAVOR }}
    - name: Upload hermes Runtime artifacts
      uses: actions/upload-artifact@v4.3.1
      with:
        name: hermes-darwin-bin-${{ inputs.FLAVOR }}
        path: /tmp/hermes/hermes-runtime-darwin/hermes-ios-${{ inputs.FLAVOR }}.tar.gz
    - name: Upload hermes osx artifacts
      uses: actions/upload-artifact@v4.3.1
      with:
        name: hermes-osx-bin-${{ inputs.FLAVOR }}
        path: /tmp/hermes/osx-bin/${{ inputs.FLAVOR }}
    - name: Upload Hermes Artifacts
      uses: actions/cache/save@v4.0.0
      if: ${{ github.ref == 'refs/heads/main' || contains(github.ref, '-stable') }} # To avoid that the cache explode.
      with:
        key: v3-hermes-artifacts-${{ inputs.FLAVOR }}-${{ inputs.HERMES_VERSION }}-${{ inputs.REACT_NATIVE_VERSION }}
        path: |
          /tmp/hermes/osx-bin/${{ inputs.FLAVOR }}
          /tmp/hermes/dSYM/${{ inputs.FLAVOR }}
          /tmp/hermes/hermes-runtime-darwin/hermes-ios-${{ inputs.FLAVOR }}.tar.gz
